# 워크플로우의 이름을 지정
name: Spring Boot CI/CD (Build, Push, Update Manifest)


# main 브랜치로 push 이벤트가 발생할 때 이 워크플로우를 실행
on:
  push:
    branches: [ "main" ]
    paths:                            # 특정 디렉터리의 파일 변경 시에만 워크플로우를 실행
      - 'springboot-app/hello/**'    
  workflow_dispatch:                  # GitHub UI에서 수동으로 워크플로우 실행 가능


jobs:
  build-and-deploy:                   # build-and-deploy라는 이름의 단일 작업을 정의
    runs-on: ubuntu-latest            # 작업이 실행될 환경을 지정


    permissions:                      # 작업 수준에서 권한 설정
      contents: write                 # 워크플로우가 Git 저장소에 다시 커밋(매니페스트 업데이트)에 필요한 권한


    steps:
      # 1. 소스 코드 체크아웃
      - name: Checkout repository     # 저장소의 소스 코드를 워크플로우 러너로 가져옴
        uses: actions/checkout@v4    


      # 2. JDK 17 설정
      - name: Set up JDK 17           # Java 17 (Temurin) 설정
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'              # Maven 빌드 속도 향상을 위해 의존성을 캐싱


      # 3. Maven으로 Spring Boot 앱 빌드
      - name: Build with Maven
        run: mvn clean package
        working-directory: ./springboot-app/hello


      # 4. 고유한 이미지 태그 생성을 위한 Git SHA 가져오기
      #    git rev-parse --short HEAD' >> 현재 커밋의 짧은 SHA 해시를 추출 >> 도커 이미지 태그로 사용
      - name: Generate short SHA
        id: vars
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT


      # 5. Docker Hub 로그인
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}


      # 6. Docker 이미지 빌드 및 푸시
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./springboot-app/hello           # 빌드 컨텍스트
          file: ./springboot-app/hello/Dockerfile   # 이미지 빌드에 사용할 Dockerfile
          push: true                                # 이미지 빌드 후 도커 허브에 푸시
          tags: |                                   # 이미지 태그 (SHA: 고유 식별자, latest: 최신)
            solasi/hello-app:${{ steps.vars.outputs.sha }}  
            solasi/hello-app:latest


      # 7. Kustomize 설치
      #    Kubernetes 매니페스트 관리를 위해 설치
      #    sed 보다 안전하게 YAML 파일을 수정하기 위해 Kustomize를 사용
      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"  | bash
          sudo mv kustomize /usr/local/bin/


      # 8. Kustomize를 사용해 Kubernetes 매니페스트 업데이트
      #    kustomize edit set image 명령을 사용해 kustomization.yaml 파일의 이미지 태그를
      #    앞에서 빌드한 새 이미지 태그(SHA 태그)로 업데이트
      - name: Update K8s manifest with new image tag
        run: kustomize edit set image solasi/hello-app=solasi/hello-app:${{ steps.vars.outputs.sha }}
        working-directory: ./springboot-app/hello/k8s


      # 9. 변경된 매니페스트 커밋 및 푸시
      #    변경된 kustomization.yaml 파일을 add, commit, push >> 이 푸시가 ArgoCD가 감지할 트리거
      - name: Commit and push manifest changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'


          git add ./springboot-app/hello/k8s/kustomization.yaml
          git commit -m "Update image tag for hello-app to ${{ steps.vars.outputs.sha }}"
          git push
